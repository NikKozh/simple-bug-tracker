@import scala.concurrent.Future
@import scala.concurrent.{ExecutionContext, Await}
@import scala.concurrent.duration.Duration
@(futureTasksMatrix: List[List[Task]], form: Form[TaskForm.Data], id: Option[Int] = None)(implicit request: MessagesRequestHeader, ec: ExecutionContext)

@main("Simple bug tracker") {

  <div class="wrapper">

    <div id="sidebar">
      <div class="card">
        <h2>Создать задачу</h2>
        <form action="@helper.CSRF(routes.Application.createTask())" method="post">
          <label>
            Название: <input name="title" type="text" required/>
          </label>

          <br>
          <br>

          <div class="left-info">
            <label>
              Описание:
              <br>
              <textarea name="description" rows="10" cols="50"></textarea>
            </label>
          </div>
          <div class="right-info">
            <p>Состояние:</p>
            <p><label><input name="state" type="radio" value="TODO" checked>TODO</label></p>
            <p><label><input name="state" type="radio" value="In Progress">In Progress</label></p>
            <p><label><input name="state" type="radio" value="Done">Done</label></p>
          </div>

          <br>
          <br>

          <p><input type="submit" value="Создать"/></p>
        </form>
      </div>

      <div class="card">
        <h2>Редактировать задачу</h2>

        @* TODO: посмотреть на наличие дублирующегося кода, мб переделать условие *@
        @if(id.isDefined) {
          @defining(Task.getTask(id.get)) { editableTask =>
            @if(editableTask.isDefined ) {

              <form action="@helper.CSRF(routes.Application.updateTask(id.get))" method="post">
                <label>
                  Название:
                  <input name="title" type="text" value="@editableTask.get.title" required/>
                </label>

                <br>
                <br>

                <div class="left-info">
                  <label>
                    Описание:
                    <br>
                    <textarea name="description" rows="10" cols="50">@editableTask.get.description</textarea>
                  </label>
                </div>
                <div class="right-info">
                  <p>Состояние:</p>

                  <p><label><input name="state" type="radio" value="TODO" @{if (editableTask.get.state == TaskState.TODO) "checked"}>TODO</label></p>
                  <p><label><input name="state" type="radio" value="In Progress" @{if (editableTask.get.state == TaskState.IN_PROGRESS) "checked"}>In Progress</label></p>
                  <p><label><input name="state" type="radio" value="Done" @{if (editableTask.get.state == TaskState.DONE) "checked"}>Done</label></p>
                </div>

                <br>
                <br>

                <input type="submit" value="Редактировать"/>
              </form>
              <form action="@helper.CSRF(routes.Application.deleteTask(id.get))" method="post">
                <input type="submit" value="Удалить"/>
              </form>
            }
          }
        } else {
          <form id="editTask">
            <label>
              Название:
              <input class="title" type="text" disabled/>
            </label>

            <br>
            <br>

            <div class="left-info">
              <label>
                Описание:
                <br>
                <textarea rows="10" cols="50" disabled></textarea>
              </label>
            </div>
            <div class="right-info">
              <p>Состояние:</p>
              <p><label><input name="state" type="radio" value="TODO" disabled>TODO</label></p>
              <p><label><input name="state" type="radio" value="In Progress" disabled>In Progress</label></p>
              <p><label><input name="state" type="radio" value="Done" disabled>Done</label></p>
            </div>

            <br>
            <br>

            <input type="submit" value="Редактировать" disabled/>
          </form>
          <form>
            <input type="submit" value="Удалить" disabled/>
          </form>
        }

        <br>
        <p><a href="/">Перейти к полнотекстовому поиску по задачам</a></p>
      </div>
    </div>

    <div id="content">
      <table id="bugsTable">
        @{import TaskState._}
        <caption><h1>СПИСОК ЗАДАЧ</h1></caption>
        <tr>
          @for(state <- TaskState.values) {
            <th>@state.toString</th>
          }
        </tr>

        @*futureTasksMatrix.onComplete{ tryMatrix => *@
          @futureTasksMatrix.map { tasksRow =>
            @*Await.result(futureTasksMatrix, Duration.Inf).map { tasksRow =>*@
              <tr>
                @tasksRow.map { task =>
                  <td>
                    @if(task != null) {
                      <a href="@routes.Application.index(Some(task.id))">
                      @task.title
                      </a>
                    }
                  </td>
                }
              </tr>
            }
      </table>
    </div>

  </div>

}
